

## High / Low bead discrepancy

```{r setup-and-libraries, echo=FALSE, warning=FALSE}
my.palette <- c(rgb(1,0,0,0.25), rgb(0,0,1,0.25))
library(data.table)
library(ggplot2)
library(ggrepel)
library(cmapR)
library(dplyr, warn=F)
```

## Load data 

```{r hi_lo_bead_input, include=FALSE}
(ds <- parse.gctx("data/DECONV_holdout_n8228x976.gctx"))
annot <- fread("data/holdout_sample_annotations.txt")
gene_annot <- fread("data/barcode_to_gene_map.txt", colClasses = c("gene_id"="character"))
ds <- annotate.gct(ds, annot, dim="col", keyfield="id")
ds <- annotate.gct(ds, gene_annot, dim="row", keyfield="gene_id")
```

## Methods

We have data from 122 experiments (pert_id) for 976 genes for 11 different methods (1 UNI method (ground-truth) and 10 DUO method - d-Peak algorithm combinations).
For each experiment we have about 10 replicates. 
The presence of numerous replicates enables us to compute the MEAN and SD of the gene expression level for all the 976 genes. This gives us an array with 122 x 976 x 2 values for each of the 11 different methods. 

## Results 

```{r, include=FALSE}
library(parallel)
handles <- unique(ds@cdesc$handle)
perts <- unique(ds@cdesc$pert_id)
gene_id <- ds@rdesc$gene_id

out <- mclapply(handles, function(h) {
  out.mean <- array(NA, c(length(perts), length(genes)))
  out.sd <- array(NA, c(length(perts), length(genes)))
  for (j in 1:length(perts)) {
     cids <- which(ds@cdesc$pert_id==perts[j] & ds@cdesc$handle==h)
     mat <- subset.gct(ds, cid=cids, rid=gene_id)@mat
     out.mean[j, ] <-  apply(log(mat), 1, mean)
     out.sd[j, ] <-  apply(log(mat), 1, sd)     
  }
  list(mean=out.mean, sd=out.sd)
})
names(out) <- handles
```


## Example for all the points ground truth vs benchmark 

```{r}
plot(out$benchmark$sd, out$`ground-truth`$sd, main="Ground-truth vs benchmark ", pch=16)
abline(0,1, col="red")
```

## Example low vs high bead proportion 

```{r}
par(mfrow=c(1, 2))
for (k in 0:1) {
  i <- ds@rdesc$high_prop == k
  plot(out$benchmark$sd[,i], out$`ground-truth`$sd[,i]
    , main=paste("high bead prop. =",k)
    , pch=".", ylim=c(0, 2), xlim=c(0, 2))
  abline(0,1, col="red")
}
```

## Compare variance ratio 

```{r}
options(digits=2)
log.sd.ratio <- mclapply(handles, function(h) {
  log(as.vector(out[[h]]$sd) / as.vector(out$`ground-truth`$sd))
})
names(log.sd.ratio) <- handles
knitr::kable(sapply(log.sd.ratio, quantile))
```


